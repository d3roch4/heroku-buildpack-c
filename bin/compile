#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2
INSTALL_DIR=$BUILD_DIR

echo "$CACHE_DIR"
ls -l $CACHE_DIR
ls -l $CACHE_DIR/*
echo "$BOOST_INCLUDEDIR"
echo "$BOOST_LIBRARYDIR"

#if [ ! -e $CACHE_DIR/cmake/bin/cmake ]; then
#  echo "instaling cmake"
#  wget https://github.com/Munett/cmake-binary/raw/master/cmake.tar.gz -O cmake.tgz
#  mkdir -p $CACHE_DIR/cmake
#  tar xzvf cmake.tgz -C $CACHE_DIR/cmake
#fi
#PATH=$CACHE_DIR/cmake/bin:$PATH

echo "-----> Configuring CMake"
cd $BUILD_DIR 
mkdir build
cd build 
cmake -DCMAKE_USE_OPENSSL=ON -DBOOST_INCLUDEDIR=$CACHE_DIR/include -DBOOST_LIBRARYDIR=$CACHE_DIR/lib -DCMAKE_INSTALL_PREFIX:PATH=$INSTALL_DIR $BUILD_DIR 

# make
echo "-----> Compiling with Make"
make -j 4

echo "-----> Instaling"
mkdir -p $INSTALL_DIR
make install
cd ..
rm -rf build
rm -rf $INSTALL_DIR/include $INSTALL_DIR/*/*.a $INSTALL_DIR/lib/cmake $INSTALL_DIR/lib/pkgconfig
echo "-----> Compilation finish"
